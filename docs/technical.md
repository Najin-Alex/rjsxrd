# Техническая документация

## Архитектура генератора

Генератор конфигов построен с использованием модульной архитектуры:

- `config/` - настройки и конфигурационные параметры
  - `servers.txt` - список ручных серверов для добавления в конфигурации
  - `URLS.txt` - список URL для основных конфигов
  - `URLS_base64.txt` - список URL для base64-кодированных подписок
  - `URLS_yaml.txt` - список URL для YAML-конфигов
  - `whitelist-all.txt` - список доменов для SNI фильтрации
  - `cidrwhitelist.txt` - список CIDR для IP фильтрации
  - `settings.py` - глобальные настройки, токены, URL-источники, часовые пояса
- `fetchers/` - модули для загрузки конфигов из внешних источников
  - `fetcher.py` - базовый загрузчик конфигов
  - `yaml_converter.py` - конвертер YAML-конфигов в формат VPN URL
  - `daily_repo_fetcher.py` - загрузка конфигов из ежедневно обновляемого репозитория
- `processors/` - основная обработка и фильтрация конфигов
  - `config_processor.py` - содержит всю основную логику обработки конфигов
- `utils/` - вспомогательные функции и утилиты
  - `file_utils.py` - файловые операции, фильтрация insecure конфигов, SNI/CIDR фильтрация
  - `logger.py` - логирование
  - `github_handler.py` - работа с GitHub API

### Основные компоненты

#### Main (`main.py`)
- Содержит только main функцию, которая вызывает другие функции из других модулей
- Основная точка входа в приложение
- Обрабатывает аргументы командной строки (dry-run)
- Оркестрирует процесс генерации конфигов

#### Fetcher (`fetchers/fetcher.py`)
- Загружает конфиги из внешних источников (обычные ссылки, base64-кодированные подписки, YAML-файлы, дополнительные источники для обхода)
- Обрабатывает ошибки и повторные попытки подключения
- Использует сессии с повторными попытками и адаптеры для устойчивости
- Добавляет заголовки User-Agent для имитации Chrome браузера
- Использует HTTP сессии с повторными попытками (Retry) для устойчивости к сетевым сбоям
- Обрабатывает различные типы HTTP ошибок и таймауты

#### Daily Repo Fetcher (`fetchers/daily_repo_fetcher.py`)
- Загружает конфиги из ежедневно обновляемого репозитория
- Использует формат именования файлов v2YYYYMMDD
- Реализует логику поиска конфигов с учетом часовых поясов (текущая дата, дата на день раньше, дата на день позже)
- Автоматически определяет и декодирует base64-кодированные конфиги
- Интегрирован с основным процессом через вызов в download_all_configs
- Использует библиотеку `zoneinfo` для работы с часовыми поясами
- Обрабатывает как прямые URL, так и base64-кодированные конфиги

#### YAML Converter (`fetchers/yaml_converter.py`)
- Конвертирует YAML-конфиги в формат VPN URL
- Поддерживает различные форматы YAML-конфигов (Clash, Surge и другие)
- Извлекает информацию о протоколах, серверах, портах, шифрах из YAML
- Конвертирует в стандартные форматы (vless://, vmess://, trojan://, ss:// и т.д.)
- Обрабатывает сложные конфигурации с несколькими серверами

#### Processor (`processors/config_processor.py`)
- Загружает конфиги из всех источников, разделяя configs из EXTRA_URLS_FOR_BYPASS от основных configs
- Создает файл all.txt с уникальными конфигами из основных источников (URLS, URLS_BASE64, URLS_YAML)
- Создает файл all-secure.txt с безопасными конфигами из основных источников
- Создает файл bypass-all.txt с SNI/CIDR bypass конфигами: применяет SNI/CIDR фильтрацию к основным configs (с фильтрацией безопасности) и добавляет extra bypass configs (с фильтрацией безопасности, но без SNI/CIDR фильтрации)
- Создает файл bypass-unsecure-all.txt с SNI/CIDR bypass конфигами: применяет SNI/CIDR фильтрацию к основным configs (без фильтрации безопасности) и добавляет extra bypass configs (без SNI/CIDR и безопасности фильтрации)
- Разделяет большие bypass файлы на части по 300 конфигов
- Создает протокол-специфичные файлы в обеих версиях (secure и unsecure) в папке split-by-protocols/
- Добавлена валидация VPN конфигов: теперь учитываются только строки, начинающиеся с поддерживаемого протокола (vless://, vmess://, trojan:// и др.) для предотвращения включения неподходящих строк в итоговые файлы
- Использует параллельные загрузки с ThreadPoolExecutor для ускорения процесса
- Поддерживает обработку разных типов источников с разной логикой фильтрации

#### File Utils (`utils/file_utils.py`)
- Содержит функцию `apply_sni_cidr_filter()` для унифицированной фильтрации по SNI и CIDR
- Функции дедупликации, фильтрации insecure конфигов и подготовки контента
- Функции извлечения хоста/порта и IP-адресов из конфигов
- **Улучшенная функция безопасности `has_insecure_setting()`**:
  - **VMess**: Проверяет `insecure`, `allowInsecure`, `security=none` в JSON конфигурации
  - **VMess**: Обнаруживает устаревший режим через `alterId > 0` (уязвим к MD5 аутентификации)
  - **VLESS**: Проверяет `allowInsecure`, `insecure`, `security=none`, `encryption=none`
  - **Trojan**: Проверяет `allowInsecure`, `insecure` параметры
  - **Shadowsocks**: Проверяет слабые шифры (RC4, CFB режимы, BF-CFB и др.)
  - **ShadowsocksR**: Проверяет слабые шифры в SSR формате
  - **TUIC**: Проверяет `skip-cert-verify` параметр
  - **Общие**: Проверяет `verify=0`, `verify=false`, `insecure=1`, `insecure=true`
- Функция `prepare_config_content()` нормализует содержимое, разделяет склеенные конфиги
- Функция `is_valid_vpn_config_url()` проверяет формат протокола://
- Функция `deduplicate_configs()` удаляет дубликаты на основе host:port

#### GitHub Handler (`utils/github_handler.py`)
- Управляет загрузкой файлов в репозиторий GitHub
- Обрабатывает конфликты SHA и повторные попытки обновления
- Обновляет информацию о файлах
- Использует GitHub API через библиотеку PyGithub
- Реализует экспоненциальную задержку при конфликтах SHA
- Поддерживает параллельную загрузку файлов через ThreadPoolExecutor
- Проверяет лимиты GitHub API и выводит предупреждения
- Сравнивает содержимое файлов для избежания лишних коммитов

## Алгоритм работы

1. **Инициализация**: Загрузка настроек из `config/settings.py`
2. **Загрузка конфигов из всех источников**:
   - Обычные URL из `URLS.txt`
   - Base64-подписки из `URLS_base64.txt`
   - YAML-файлы из `URLS_yaml.txt`
   - Ежедневный репозиторий
   - Дополнительные bypass URL из `EXTRA_URLS_FOR_BYPASS`
   - Ручные серверы из `servers.txt`
3. **Создание файла all.txt** с уникальными конфигами из основного списка
4. **Создание файла all-secure.txt** с безопасными конфигами из основного списка
5. **Создание безопасных обходных конфигов** (папка bypass/):
   - Применение SNI/CIDR фильтрации к основному списку configs (с фильтрацией безопасности)
   - Добавление secure extra bypass configs (без SNI/CIDR фильтрации)
6. **Разделение безопасных обходных конфигов** на части по 300 configs
7. **Создание небезопасных обходных конфигов** (папка bypass-unsecure/):
   - Применение SNI/CIDR фильтрации к основному списку configs (без фильтрации безопасности)
   - Добавление всех extra bypass configs (без SNI/CIDR и безопасности фильтрации)
8. **Разделение небезопасных обходных конфигов** на части по 300 configs
9. **Создание протокол-специфичных файлов** в обеих версиях (secure и unsecure) в папке split-by-protocols/
10. **Загрузка всех файлов** в репозиторий GitHub

## Подробное описание функций безопасности

### Функция `has_insecure_setting(config_line: str) -> bool`

Эта функция выполняет комплексную проверку безопасности VPN-конфигураций и возвращает `True`, если конфигурация считается небезопасной, и `False` если безопасной.

#### VMess-специфичные проверки:
- Проверяет JSON-конфигурацию VMess на наличие `insecure`, `allowInsecure` параметров со значениями `true`, `1`, `'true'`, `'1'`
- Проверяет `security`/`scy` поля в JSON на значение `'none'`
- **НОВОЕ**: Проверяет `alterId`/`aid` поле - если значение > 0, то это устаревший режим с MD5-аутентификацией, который считается уязвимым

#### VLESS-специфичные проверки:
- Проверяет параметры `allowInsecure` и `insecure` в URL-параметрах
- Проверяет `security=none` в URL-параметрах
- Проверяет `encryption=none` в URL-параметрах (но только если нет TLS/REALITY)

#### Trojan-специфичные проверки:
- Проверяет `allowInsecure` и `insecure` параметры в URL

#### Shadowsocks-специфичные проверки:
- Парсит URL в формате `ss://method:password@host:port` или `ss://base64(method:password)@host:port`
- Проверяет слабые шифры: `rc4-md5`, `aes-128-cfb`, `aes-192-cfb`, `aes-256-cfb`, `bf-cfb`, `salsa20`, `chacha20`, и другие устаревшие методы
- Сравнивает метод шифрования с белым списком безопасных методов

#### ShadowsocksR-специфичные проверки:
- Парсит base64-кодированный формат SSR: `ssr://base64(host:port:protocol:method:obfs:base64(password))`
- Извлекает метод шифрования и проверяет его на уязвимость
- Проверяет слабые шифры, аналогично Shadowsocks

#### TUIC-специфичные проверки:
- Проверяет параметр `skip-cert-verify` в URL-параметрах

#### Общие проверки:
- Проверяет `verify=0` или `verify=false` в URL-параметрах
- Проверяет `insecure=1`, `insecure=true`, `insecure=yes`, `insecure=on` в URL-параметрах

## Оптимизации

- **Параллельные загрузки**: Использование ThreadPoolExecutor для одновременной загрузки из нескольких источников
- **Кэширование и проверка изменений**: Сравнение содержимого файлов перед загрузкой для избежания лишних коммитов
- **Разделение больших файлов**: Максимум 300 конфигов на файл для мобильной производительности
- **Умные регулярные выражения**: Эффективные паттерны для быстрой фильтрации и извлечения данных
- **Фильтрация конфигов с insecure параметрами**: Повышенная безопасность за счет исключения небезопасных конфигов
- **Поддержка обработки различных типов источников**: Обработка обычных ссылок, base64-подписок, YAML-файлов
- **Четкое разделение ответственности**: Модульная архитектура для лучшей поддержки кода
- **Эффективная дедупликация**: Удаление дубликатов на основе host:port комбинации
- **Потокобезопасное логирование**: Использование блокировок для корректного логирования в многопоточной среде